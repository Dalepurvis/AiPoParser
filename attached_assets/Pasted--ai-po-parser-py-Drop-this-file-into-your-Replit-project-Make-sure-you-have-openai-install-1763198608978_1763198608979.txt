# ai_po_parser.py
#
# Drop this file into your Replit project.
# Make sure you have `openai` installed:
#   pip install openai
#
# Then set your OPENAI_API_KEY in Replit Secrets.
#
# You can test this file by running it directly in Replit.

import os
import json
from typing import Any, Dict, List

try:
    from openai import OpenAI
    client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))
except ImportError:
    client = None
    print("WARNING: openai package not installed. Run: pip install openai")


# ---------------------------------------
# 1. System Prompt Builder
# ---------------------------------------

def build_system_message(
    business_rules: Dict[str, Any],
    suppliers: List[Dict[str, Any]],
    price_rows: List[Dict[str, Any]],
) -> str:
    """
    Build the system prompt text for the PO draft generator.
    This includes the JSON schema and the contextual data.
    """

    business_rules_json = json.dumps(business_rules, ensure_ascii=False, indent=2)
    suppliers_json = json.dumps(suppliers, ensure_ascii=False, indent=2)
    price_rows_json = json.dumps(price_rows, ensure_ascii=False, indent=2)

    system_prompt = f"""
You are an AI purchase-order assistant for a trade/retail business.
Your job is to:
1) Interpret the user's free-text request for a purchase order.
2) Use the known supplier price lists and business rules to propose a DRAFT purchase order.
3) ALWAYS surface uncertainty and ask clarifying questions instead of guessing.
4) Think about profitability: suggest more profitable or more consistent alternatives when appropriate.
5) Respond ONLY with STRICT JSON matching the schema provided below. No extra text, no explanations outside JSON.

You MUST follow these rules:
- If you are not at least 0.8 confident about a field (like SKU, quantity, or price), add that field name to `ai_uncertain_fields` and create an entry in `questions_for_user`.
- NEVER invent a new SKU or product that does not appear in the input price lists or business rules.
- If multiple SKUs or price breaks could apply, present them as `suggested_options` in `questions_for_user` and do NOT silently choose the lower-priced option.
- If there is not enough information to build a draft, you MUST still return a valid JSON structure with empty or null fields and helpful `questions_for_user`.
- Always include a short `reasoning_summary` with decision, considerations, alternatives, and a global confidence score.

IMPORTANT JSON RULES:
- You MUST return ONLY JSON. No markdown, no backticks, no comments.
- Do NOT include trailing commas.
- Do NOT include any keys that are not in the schema.
- If you don't know a value, use null (for numbers/strings) or an empty string/array as appropriate.
- Make sure the JSON is syntactically valid and can be parsed by a standard JSON parser.

JSON SCHEMA (for your response):

{{
  "draft_po": {{
    "supplier_name": "string",
    "status": "draft",
    "items": [
      {{
        "sku": "string or null",
        "product_name": "string",
        "unit_type": "string",
        "requested_quantity_raw": "string",
        "quantity": 0,
        "unit_price": null,
        "currency": "string",
        "line_total": null,
        "price_source": "string",
        "ai_confidence": 0.0,
        "ai_uncertain_fields": ["string"],
        "notes": "string"
      }}
    ],
    "extra_notes_for_supplier": "string",
    "delivery_instructions": "string",
    "business_profitability_hints": [
      {{
        "message": "string",
        "estimated_savings": null,
        "applies_to_item_indexes": [0]
      }}
    ]
  }},
  "questions_for_user": [
    {{
      "id": "string",
      "question": "string",
      "reason": "string",
      "related_item_indexes": [0],
      "suggested_options": ["string"]
    }}
  ],
  "reasoning_summary": {{
    "overall_decision": "string",
    "considerations": ["string"],
    "alternatives": ["string"],
    "global_confidence": 0.0
  }}
}}

CONTEXT YOU KNOW:

BUSINESS_RULES:
{business_rules_json}

EXISTING_SUPPLIERS:
{suppliers_json}

PRICE_LIST_ROWS:
{price_rows_json}

Remember:
- Use PRICE_LIST_ROWS to find matching SKUs, unit types (box/pallet/m2), and price breaks.
- Use BUSINESS_RULES only as high-level guidance (e.g., default tax, fitting rates), not to invent new products.

Return ONLY a JSON object that matches the schema.
"""
    return system_prompt.strip()


# ---------------------------------------
# 2. Helper: Extract JSON from model output
# ---------------------------------------

def extract_json(text: str) -> Dict[str, Any]:
    """
    Try to extract a JSON object from the model output.
    The model *should* return pure JSON, but we defensively
    grab the first { ... } block we can parse.
    """
    text = text.strip()

    # Fast path: try whole string
    try:
        return json.loads(text)
    except Exception:
        pass

    # Fallback: find first '{' and last '}'
    start = text.find("{")
    end = text.rfind("}")
    if start != -1 and end != -1 and end > start:
        candidate = text[start : end + 1]
        try:
            return json.loads(candidate)
        except Exception:
            pass

    raise ValueError("Could not parse valid JSON from model output.")


# ---------------------------------------
# 3. Main Function: Generate Draft PO
# ---------------------------------------

def generate_draft_po(
    user_request: str,
    business_rules: Dict[str, Any],
    suppliers: List[Dict[str, Any]],
    price_rows: List[Dict[str, Any]],
    model: str = "gpt-4.1-mini",
) -> Dict[str, Any]:
    """
    Call the LLM to generate a draft purchase order from a natural language request.

    Returns a Python dict with keys:
      - draft_po
      - questions_for_user
      - reasoning_summary
    """
    if client is None:
        raise RuntimeError("OpenAI client not available. Install openai and set OPENAI_API_KEY.")

    system_message = build_system_message(
        business_rules=business_rules,
        suppliers=suppliers,
        price_rows=price_rows,
    )

    messages = [
        {"role": "system", "content": system_message},
        {
            "role": "user",
            "content": f'User request: "{user_request}"',
        },
    ]

    response = client.chat.completions.create(
        model=model,
        messages=messages,
        temperature=0.0,
    )

    raw_text = response.choices[0].message.content
    data = extract_json(raw_text)
    return data


# ---------------------------------------
# 4. Demo / Test Run
# ---------------------------------------

if __name__ == "__main__":
    """
    Simple test so you can see it working in Replit.

    - This uses tiny mock data for suppliers and price rows.
    - Replace this with your real DB data when ready.
    """

    # Mock business rules
    business_rules = {
        "default_currency": "GBP",
        "notes": "Example rules. Add fitting rates, default tax, etc. later."
    }

    # Mock suppliers
    suppliers = [
        {
            "id": 1,
            "name": "EverFloor Supplies",
            "email": "orders@everfloor.example.com",
            "phone": "+44 1234 567890"
        }
    ]

    # Mock price list rows
    price_rows = [
        {
            "id": 123,
            "supplier_id": 1,
            "sku": "HYDRO-301",
            "product_name": "HydroLoc Grey Herringbone",
            "unit_type": "box",
            "min_qty": 1,
            "max_qty": None,
            "unit_price": 18.99,
            "currency": "GBP",
            "notes": "Standard box price"
        },
        {
            "id": 124,
            "supplier_id": 1,
            "sku": "HYDRO-301",
            "product_name": "HydroLoc Grey Herringbone",
            "unit_type": "pallet",
            "min_qty": 50,
            "max_qty": None,
            "unit_price": 17.50,
            "currency": "GBP",
            "notes": "Discounted pallet price (50 boxes)"
        }
    ]

    # Example user request
    test_request = "Order a full pallet of HydroLoc Grey Herringbone for the Nottingham warehouse from EverFloor Supplies."

    print("Sending test request to model...")
    try:
        result = generate_draft_po(
            user_request=test_request,
            business_rules=business_rules,
            suppliers=suppliers,
            price_rows=price_rows,
            model="gpt-4.1-mini",  # change to whatever model you use
        )
        print("\nRaw model JSON parsed as Python dict:\n")
        print(json.dumps(result, indent=2))
    except Exception as e:
        print("Error while generating draft PO:", e)